import { useState } from 'react';
import { useStore } from '../store/useStore';
import { Button, Input, Card } from './ui';
import { AccountingActions } from '../lib/accounting';
import { Leaf, Plus, Trash2, ArrowRight } from 'lucide-react';
import type { InventoryItem, AssetItem } from '../types';

export const Onboarding = () => {
    const {
        updateAccounts, setInitialized,
        addInventoryItem, addAssetItem,
        reset
    } = useStore();

    const [step, setStep] = useState(1);

    // Temporary State for wizard
    const [tempInv, setTempInv] = useState<InventoryItem[]>([]);
    const [tempAssets, setTempAssets] = useState<AssetItem[]>([]);
    const [cash, setCash] = useState('');
    const [bank, setBank] = useState('');

    // Step 1: Inventory
    const [invForm, setInvForm] = useState({ name: '', cost: '', stock: '' });
    const addInv = () => {
        if (!invForm.name || !invForm.cost) return;
        const newItem: InventoryItem = {
            id: crypto.randomUUID(),
            name: invForm.name,
            cost: parseFloat(invForm.cost || '0'),
            stock: parseFloat(invForm.stock || '0') // Initial stock usually 0 or counted
        };
        setTempInv([...tempInv, newItem]);
        setInvForm({ name: '', cost: '', stock: '' });
    };

    // Step 2: Assets
    const [assetForm, setAssetForm] = useState({ name: '', value: '' });
    const addAsset = () => {
        if (!assetForm.name || !assetForm.value) return;
        const newItem: AssetItem = { id: crypto.randomUUID(), name: assetForm.name, value: parseFloat(assetForm.value || '0') };
        setTempAssets([...tempAssets, newItem]);
        setAssetForm({ name: '', value: '' });
    };

    // Finalize
    const finish = () => {
        // Commit all data
        tempInv.forEach(i => addInventoryItem(i));
        tempAssets.forEach(a => addAssetItem(a));

        const cashVal = parseFloat(cash || '0');
        const bankVal = parseFloat(bank || '0');

        // Calculate totals for accounting
        const totalInvValue = tempInv.reduce((acc, i) => acc + (i.cost * i.stock), 0);
        const totalAssetValue = tempAssets.reduce((acc, a) => acc + a.value, 0);

        const initialAccounts = AccountingActions.initializeWithEquity(cashVal, bankVal, totalInvValue, totalAssetValue);
        updateAccounts(() => initialAccounts);
        setInitialized(true);
    };

    return (
        <div className="min-h-screen flex items-center justify-center p-4 bg-jardin-bg">
            <div className="w-full max-w-2xl">
                <div className="flex justify-center mb-8 text-jardin-primary"><Leaf size={64} /></div>

                {step === 1 && (
                    <Card>
                        <h2 className="text-xl font-bold mb-2">1. Inventario Inicial</h2>
                        <p className="text-sm text-gray-500 mb-6">Agregue sus insumos actuales uno par uno. Especifique unidad en el nombre (ej: Leche 1L).</p>

                        <div className="flex gap-2 mb-4">
                            <Input placeholder="Nombre (ej: Harina 1kg)" value={invForm.name} onChange={e => setInvForm({ ...invForm, name: e.target.value })} />
                            <Input type="number" placeholder="Costo Unit." className="w-32" value={invForm.cost} onChange={e => setInvForm({ ...invForm, cost: e.target.value })} />
                            <Input type="number" placeholder="Cant." className="w-24" value={invForm.stock} onChange={e => setInvForm({ ...invForm, stock: e.target.value })} />
                            <Button onClick={addInv}><Plus size={20} /></Button>
                        </div>

                        <div className="bg-gray-50 rounded-xl p-4 min-h-[150px] max-h-[300px] overflow-y-auto space-y-2 mb-6">
                            {tempInv.map((item, idx) => (
                                <div key={item.id} className="flex justify-between items-center text-sm bg-white p-2 rounded border">
                                    <span>{item.name} ({item.stock})</span>
                                    <div className="flex items-center gap-4">
                                        <span className="font-mono">₡{item.cost * item.stock}</span>
                                        <button onClick={() => setTempInv(tempInv.filter((_, i) => i !== idx))} className="text-red-500"><Trash2 size={16} /></button>
                                    </div>
                                </div>
                            ))}
                            {tempInv.length === 0 && <div className="text-center text-gray-400 py-8">Lista vacía</div>}
                        </div>
                        <Button className="w-full" onClick={() => setStep(2)}>Siguiente: Activos <ArrowRight className="ml-2" size={18} /></Button>
                    </Card>
                )}

                {step === 2 && (
                    <Card>
                        <h2 className="text-xl font-bold mb-2">2. Activos Fijos</h2>
                        <p className="text-sm text-gray-500 mb-6">Equipos, maquinaria o mobiliario importante.</p>

                        <div className="flex gap-2 mb-4">
                            <Input placeholder="Nombre (ej: Crepera Industrial)" value={assetForm.name} onChange={e => setAssetForm({ ...assetForm, name: e.target.value })} />
                            <Input type="number" placeholder="Valor Estimado" className="w-40" value={assetForm.value} onChange={e => setAssetForm({ ...assetForm, value: e.target.value })} />
                            <Button onClick={addAsset}><Plus size={20} /></Button>
                        </div>

                        <div className="bg-gray-50 rounded-xl p-4 min-h-[150px] max-h-[300px] overflow-y-auto space-y-2 mb-6">
                            {tempAssets.map((item, idx) => (
                                <div key={item.id} className="flex justify-between items-center text-sm bg-white p-2 rounded border">
                                    <span>{item.name}</span>
                                    <div className="flex items-center gap-4">
                                        <span className="font-mono">₡{item.value}</span>
                                        <button onClick={() => setTempAssets(tempAssets.filter((_, i) => i !== idx))} className="text-red-500"><Trash2 size={16} /></button>
                                    </div>
                                </div>
                            ))}
                            {tempAssets.length === 0 && <div className="text-center text-gray-400 py-8">Sin activos</div>}
                        </div>
                        <div className="flex gap-2">
                            <Button variant="ghost" onClick={() => setStep(1)}>Atrás</Button>
                            <Button className="flex-1" onClick={() => setStep(3)}>Siguiente: Efectivo <ArrowRight className="ml-2" size={18} /></Button>
                        </div>
                    </Card>
                )}

                {step === 3 && (
                    <Card>
                        <h2 className="text-xl font-bold mb-2">3. Saldos de Efectivo</h2>
                        <p className="text-sm text-gray-500 mb-6">Dinero disponible actualmente para iniciar operaciones.</p>

                        <div className="space-y-4 mb-8">
                            <div>
                                <label className="text-sm font-medium ml-1">Caja Chica (Efectivo)</label>
                                <Input type="number" value={cash} onChange={e => setCash(e.target.value)} placeholder="0" />
                            </div>
                            <div>
                                <label className="text-sm font-medium ml-1">Cuenta Bancaria</label>
                                <Input type="number" value={bank} onChange={e => setBank(e.target.value)} placeholder="0" />
                            </div>
                        </div>

                        <div className="p-4 bg-green-50 rounded-xl mb-6 text-center">
                            <div className="text-xs uppercase tracking-widest text-green-800 opacity-70 mb-1">Patrimonio Inicial Calculado</div>
                            <div className="text-3xl font-bold text-green-900">
                                ₡{((parseFloat(cash || '0') + parseFloat(bank || '0') + tempInv.reduce((a, b) => a + b.cost * b.stock, 0) + tempAssets.reduce((a, b) => a + b.value, 0))).toLocaleString()}
                            </div>
                        </div>

                        <div className="flex gap-2">
                            <Button variant="ghost" onClick={() => setStep(2)}>Atrás</Button>
                            <Button className="flex-1" onClick={finish}>Iniciar El Jardín</Button>
                        </div>
                    </Card>
                )}
            </div>
        </div>
    );
};
